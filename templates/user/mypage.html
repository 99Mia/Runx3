<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>RunTogether - ë§ˆì´í˜ì´ì§€</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.1.0/fonts/remixicon.css" rel="stylesheet"/>
    <style>
        body { background: #f9fafb; font-family: 'Inter', sans-serif; }
        .tab-active { background: #2E8B57; color: white; }
        .tab-inactive { background: #f1f5f9; color: #374151; }
    </style>
</head>

<body class="flex flex-col min-h-screen">

<!-- âœ… í—¤ë” -->
<header class="bg-white shadow-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto flex justify-between items-center px-6 py-4">

        <a href="/main" class="flex items-center gap-2">
            <img th:src="@{/images/logo01.png}"
                 alt="RunTogether Logo"
                 class="h-10 object-contain drop-shadow-md">
        </a>

        <nav class="hidden md:flex gap-8 font-medium">
            <a href="/route/list" class="hover:text-green-600">ì½”ìŠ¤</a>
            <a href="/board/list" class="hover:text-green-600">ì»¤ë®¤ë‹ˆí‹°</a>
            <a href="/challenges" class="hover:text-green-600">ëŒ€íšŒì†Œì‹</a>
            <a href="/user/mypage" class="text-green-700 font-semibold">ë§ˆì´í˜ì´ì§€</a>
            <form th:if="${#authorization.expression('isAuthenticated()')}"
                  th:action="@{/user/logout}" method="post" class="inline">
                <button type="submit"
                        class="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-lg text-sm">
                    ë¡œê·¸ì•„ì›ƒ
                </button>
            </form>
        </nav>
    </div>
</header>

<!-- âœ… ë³¸ë¬¸ -->
<main class="flex-1 max-w-7xl mx-auto px-6 py-12 grid grid-cols-1 md:grid-cols-4 gap-8">

    <!-- ğŸ§­ ì‚¬ì´ë“œ íƒ­ -->
    <aside class="md:col-span-1 bg-white shadow-md rounded-xl p-6 space-y-4">
        <h3 class="text-xl font-semibold mb-4 text-gray-800">ë§ˆì´í˜ì´ì§€</h3>
        <button id="tab-profile" class="w-full py-2 rounded-lg tab-active">í”„ë¡œí•„</button>
        <button id="tab-activity" class="w-full py-2 rounded-lg tab-inactive">í™œë™ ìš”ì•½</button>
        <button id="tab-course" class="w-full py-2 rounded-lg tab-inactive">ì½”ìŠ¤ ê¸°ë¡</button>
        <button id="tab-subscription" class="w-full py-2 rounded-lg tab-inactive">êµ¬ë… ì •ë³´</button>
    </aside>

    <!-- ğŸ§¾ ì½˜í…ì¸  ì˜ì—­ -->
    <section class="md:col-span-3 space-y-8">

        <!-- âœ… í”„ë¡œí•„ -->
        <div id="content-profile" class="tab-content">
            <div class="bg-white shadow-lg rounded-2xl p-10 flex flex-col gap-10 min-h-[700px] justify-center">
                <div class="flex flex-col md:flex-row items-center justify-center gap-10">
                    <img th:src="${user != null && user.profileImage != null ? user.profileImage : '/images/default-profile.png'}"
                         class="w-40 h-40 rounded-full border-4 border-green-300 object-cover shadow-md">
                    <div class="text-center md:text-left">
                        <h2 class="text-4xl font-extrabold text-gray-800 mb-2" th:text="|${user.nickname} ë‹˜|">í™ê¸¸ë™ ë‹˜</h2>
                        <p class="text-gray-600 text-lg leading-relaxed mb-4"
                           th:text="${mypage.bio} ?: 'ì˜¤ëŠ˜ë„ ì¦ê²ê²Œ ë‹¬ë ¤ìš”! RunTogetherì™€ í•¨ê»˜ğŸƒâ€â™‚ï¸'">
                            ì˜¤ëŠ˜ë„ ì¦ê²ê²Œ ë‹¬ë ¤ìš”! RunTogetherì™€ í•¨ê»˜ğŸƒâ€â™‚ï¸
                        </p>
                        <a href="/user/profile/edit"
                           class="inline-block bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-semibold transition-all shadow-sm hover:shadow-md">
                            í”„ë¡œí•„ ìˆ˜ì •
                        </a>
                    </div>
                </div>

                <!-- ğŸ“Š í™œë™ ìš”ì•½ -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-8 mt-8">
                    <div class="bg-white rounded-xl shadow p-6 text-center border border-gray-100">
                        <p class="text-gray-500 text-sm mb-2">ì´ ê±°ë¦¬</p>
                        <p class="text-3xl font-bold text-green-600" th:text="|${mypage.activity.totalDistance} km|">0 km</p>
                    </div>
                    <div class="bg-white rounded-xl shadow p-6 text-center border border-gray-100">
                        <p class="text-gray-500 text-sm mb-2">ì´ ì‹œê°„</p>
                        <p class="text-3xl font-bold text-green-600" th:text="|${mypage.activity.totalTime} ë¶„|">0 ë¶„</p>
                    </div>
                    <div class="bg-white rounded-xl shadow p-6 text-center border border-gray-100">
                        <p class="text-gray-500 text-sm mb-2">í‰ê·  í˜ì´ìŠ¤</p>
                        <p class="text-3xl font-bold text-green-600" th:text="|${mypage.activity.averagePace} ë¶„/km|">0 ë¶„/km</p>
                    </div>
                </div>

                <!-- ğŸ… ë±ƒì§€ -->
                <div class="flex flex-wrap gap-4 justify-center md:justify-start mt-6">
                    <span class="bg-yellow-100 text-yellow-700 px-4 py-2 rounded-full text-sm font-medium shadow-sm">ğŸ… ë§ˆë¼í†¤ ì´ˆë³´</span>
                    <span class="bg-green-100 text-green-700 px-4 py-2 rounded-full text-sm font-medium shadow-sm">ğŸ’ª ê¾¸ì¤€í•œ ëŸ¬ë„ˆ</span>
                    <span class="bg-blue-100 text-blue-700 px-4 py-2 rounded-full text-sm font-medium shadow-sm">ğŸ’¬ ì»¤ë®¤ë‹ˆí‹° í™œë°œëŸ¬</span>
                </div>
            </div>
        </div>

        <!-- âœ… í™œë™ ìš”ì•½ -->
        <div id="content-activity" class="tab-content hidden">
            <div class="bg-white shadow-md rounded-xl p-8">
                <h3 class="text-xl font-semibold mb-6 text-gray-800">í™œë™ ìš”ì•½</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-6 text-center">
                    <div class="bg-blue-50 p-5 rounded-xl">
                        <p>ì´ ê±°ë¦¬</p>
                        <p class="text-2xl font-bold text-blue-600" th:text="|${mypage.activity.totalDistance} km|">0 km</p>
                    </div>
                    <div class="bg-green-50 p-5 rounded-xl">
                        <p>ì´ ì‹œê°„</p>
                        <p class="text-2xl font-bold text-green-600" th:text="|${mypage.activity.totalTime} ë¶„|">0 ë¶„</p>
                    </div>
                    <div class="bg-orange-50 p-5 rounded-xl">
                        <p>í‰ê·  í˜ì´ìŠ¤</p>
                        <p class="text-2xl font-bold text-orange-600" th:text="|${mypage.activity.averagePace} ë¶„/km|">0 ë¶„/km</p>
                    </div>
                    <div class="bg-indigo-50 p-5 rounded-xl">
                        <p>ê²Œì‹œê¸€</p>
                        <p class="text-2xl font-bold text-indigo-600" th:text="${mypage.activity.postCount}">0</p>
                    </div>
                    <div class="bg-pink-50 p-5 rounded-xl">
                        <p>ëŒ“ê¸€</p>
                        <p class="text-2xl font-bold text-pink-600" th:text="${mypage.activity.commentCount}">0</p>
                    </div>
                    <div class="bg-yellow-50 p-5 rounded-xl">
                        <p>ë¶ë§ˆí¬</p>
                        <p class="text-2xl font-bold text-yellow-600" th:text="${mypage.activity.bookmarkCount}">0</p>
                    </div>

                    <!-- âœ… ì›”ë³„ í†µê³„ ê·¸ë˜í”„ -->
                    <div class="col-span-full mt-12">
                        <h4 class="text-lg font-semibold text-gray-800 mb-6">ğŸ“Š ìµœê·¼ 6ê°œì›” í™œë™ ì¶”ì´</h4>
                        <div class="bg-gray-50 rounded-xl shadow-md p-8">
                            <div class="relative w-full" style="height:480px;">
                                <canvas id="activityChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                    <script th:inline="javascript">
                        /*<![CDATA[*/
                        const monthlyData = JSON.parse(/*[[${monthlyStatsJson}]]*/ '[]');
                        if (monthlyData && monthlyData.length > 0) {
                            const labels = monthlyData.map(d => d.month);
                            const distances = monthlyData.map(d => d.totalDistance);
                            const posts = monthlyData.map(d => d.postCount);
                            const comments = monthlyData.map(d => d.commentCount);
                            const bookmarks = monthlyData.map(d => d.bookmarkCount);

                            new Chart(document.getElementById("activityChart"), {
                                type: 'line',
                                data: {
                                    labels: labels.reverse(),
                                    datasets: [
                                        { label: 'ì´ ê±°ë¦¬ (km)', data: distances.reverse(), borderColor: '#16a34a', backgroundColor: 'rgba(22,163,74,0.1)', tension: 0.4, fill: true },
                                        { label: 'ê²Œì‹œê¸€ ìˆ˜', data: posts.reverse(), borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', tension: 0.4, fill: true },
                                        { label: 'ëŒ“ê¸€ ìˆ˜', data: comments.reverse(), borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,0.1)', tension: 0.4, fill: true },
                                        { label: 'ë¶ë§ˆí¬ ìˆ˜', data: bookmarks.reverse(), borderColor: '#ec4899', backgroundColor: 'rgba(236,72,153,0.1)', tension: 0.4, fill: true }
                                    ]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: { legend: { position: 'bottom' } },
                                    scales: {
                                        y: { beginAtZero: true, title: { display: true, text: 'í™œë™ëŸ‰' } }
                                    }
                                }
                            });
                        }
                        /*]]>*/
                    </script>
                </div>
            </div>
        </div>

        <!-- âœ… ì½”ìŠ¤ ê¸°ë¡ -->
        <div id="content-course" class="tab-content hidden">
            <div class="bg-white shadow-md rounded-xl p-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">ë‚˜ì˜ ì½”ìŠ¤ ê¸°ë¡</h3>
                    <a href="/route/register"
                       class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
                        + ì½”ìŠ¤ ë“±ë¡
                    </a>
                </div>
                <table class="w-full text-center border-collapse">
                    <thead>
                    <tr class="bg-gray-100 text-gray-700">
                        <th class="py-3 border-b">ì½”ìŠ¤ëª…</th>
                        <th class="py-3 border-b">ê±°ë¦¬</th>
                        <th class="py-3 border-b">ì†Œìš”ì‹œê°„</th>
                        <th class="py-3 border-b">ì™„ë£Œì¼</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="course : ${mypage.courses}" class="hover:bg-gray-50">
                        <td th:text="${course.courseName}" class="py-3 border-b">ì½”ìŠ¤ A</td>
                        <td th:text="${course.distance}" class="py-3 border-b">10</td>
                        <td th:text="${course.timeSpent}" class="py-3 border-b">60</td>
                        <td th:text="${course.completedAt}" class="py-3 border-b">2025-11-05</td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(mypage.courses)}">
                        <td colspan="4" class="text-gray-500 py-6">ë“±ë¡ëœ ì½”ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- âœ… êµ¬ë… ì •ë³´ -->
        <div id="content-subscription" class="tab-content hidden">
            <div class="bg-white shadow-lg rounded-2xl p-10">
                <h3 class="text-2xl font-bold mb-6 text-green-700 flex items-center gap-2">
                    <i class="ri-vip-crown-line text-yellow-500 text-3xl"></i>
                    êµ¬ë… ì •ë³´
                </h3>
                <div id="subscription-content" class="text-gray-700">
                    <p>â³ êµ¬ë… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
                </div>
            </div>
        </div>


    </section>
</main>

<!-- âœ… í‘¸í„° -->
<footer class="bg-gray-900 text-gray-300 py-8 mt-auto">
    <div class="max-w-7xl mx-auto text-center text-sm">
        <p>Â© 2025 RunTogether. All rights reserved.</p>
    </div>
</footer>

<!-- âœ… íƒ­ ì „í™˜ ìŠ¤í¬ë¦½íŠ¸ -->
<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener("DOMContentLoaded", async function() {
        const tabs = ['profile', 'activity', 'course', 'subscription'];
        const userId = /*[[${user.userId}]]*/ 0;

        function showTab(tab) {
            tabs.forEach(t => {
                document.getElementById(`tab-${t}`).classList.remove('tab-active');
                document.getElementById(`tab-${t}`).classList.add('tab-inactive');
                document.getElementById(`content-${t}`).classList.add('hidden');
            });
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
            document.getElementById(`content-${tab}`).classList.remove('hidden');
        }

        const params = new URLSearchParams(window.location.search);
        const activeTab = params.get('tab') || 'profile';
        showTab(activeTab);

        tabs.forEach(tab => {
            const button = document.getElementById(`tab-${tab}`);
            if (button) {
                button.addEventListener('click', () => {
                    showTab(tab);
                    const url = new URL(window.location);
                    url.searchParams.set('tab', tab);
                    window.history.replaceState({}, '', url);
                });
            }
        });

        const subContainer = document.getElementById("subscription-content");
        try {
            const res = await fetch(`/api/mypage/subscription/${userId}`);
            if (!res.ok) throw new Error("êµ¬ë… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            const sub = await res.json();

            if (sub.status === "ACTIVE") {
                // âœ… ë‚¨ì€ ê¸°ê°„ ê³„ì‚° (ì‹œì‘ì¼ + 30ì¼ - ì˜¤ëŠ˜)
                const start = new Date(sub.startedAt);
                const expire = new Date(start);
                expire.setDate(expire.getDate() + 30);
                const now = new Date();
                const remain = Math.max(0, Math.ceil((expire - now) / (1000 * 60 * 60 * 24))); // ë‚¨ì€ ì¼ìˆ˜ ê³„ì‚°
                const percent = Math.min(100, (1 - remain / 30) * 100);
                subContainer.innerHTML = `
    <div class="bg-gradient-to-r from-green-50 to-green-100 border border-green-200 rounded-xl p-6 space-y-4 shadow-sm">
        <div class="flex items-center justify-between">
            <p class="text-lg font-semibold">ğŸ’ í˜„ì¬ í”Œëœ</p>
            <span class="text-green-700 font-bold text-xl">${sub.plan}</span>
        </div>
        <div class="flex items-center justify-between">
            <p class="text-lg font-semibold">ğŸ“… ì‹œì‘ì¼</p>
            <span>${sub.startedAt ? sub.startedAt.split('T')[0] : '-'}</span>
        </div>
        <div class="flex items-center justify-between">
            <p class="text-lg font-semibold">â° ë‚¨ì€ ê¸°ê°„</p>
            <span class="font-medium text-gray-800">${remain}ì¼ ë‚¨ìŒ</span>
        </div>

        <div class="w-full bg-gray-200 rounded-full h-3 mt-3">
            <div class="bg-green-500 h-3 rounded-full transition-all" style="width: ${percent}%;"></div>
        </div>

        <div class="flex items-center justify-between pt-5 border-t border-gray-200 mt-5">
            <span class="text-sm font-medium text-gray-600">
                ìƒíƒœ:
                <span class="px-3 py-1 rounded-full text-white text-sm font-semibold
                    ${sub.status === 'ACTIVE' ? 'bg-green-500' : 'bg-gray-400'}">
                    ${sub.status}
                </span>
            </span>
            <button id="cancelBtn"
                class="bg-red-500 hover:bg-red-600 text-white px-5 py-2 rounded-lg font-semibold transition">
                êµ¬ë… ì·¨ì†Œ
            </button>
        </div>
    </div>
`;

                document.getElementById("cancelBtn").addEventListener("click", async () => {
                    if (!confirm("ì •ë§ êµ¬ë…ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                    const cancelRes = await fetch(`/api/mypage/subscription/${userId}/cancel`, { method: "POST" });
                    if (cancelRes.ok) {
                        alert("êµ¬ë…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                        location.reload();
                    } else alert("êµ¬ë… ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                });
            } else {
                subContainer.innerHTML = `
                    <div class="bg-gray-50 border border-gray-200 rounded-xl p-6 text-center shadow-sm">
                        <p class="text-gray-600 mb-6">í˜„ì¬ êµ¬ë… ì¤‘ì¸ í”Œëœì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        <button id="startBtn"
                                class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl font-semibold transition">
                          ğŸ’³ í”„ë¦¬ë¯¸ì—„ êµ¬ë… ì‹œì‘í•˜ê¸°
                        </button>
                    </div>
                `;
                document.getElementById("startBtn").addEventListener("click", () => {
                    window.location.href = '/subscription/payment';
                });
            }
        } catch (error) {
            subContainer.innerHTML = `<p class="text-red-500">\${error.message}</p>`;
        }
    });
    /*]]>*/
</script>




</body>
</html>