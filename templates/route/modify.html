<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{route/layout.html}">

<!-- ğŸ”¹ route.css ë¶ˆëŸ¬ì˜¤ê¸° -->
<th:block layout:fragment="pageStyles">
    <link rel="stylesheet" th:href="@{/css/route.css}">
</th:block>

<div layout:fragment="content">

    <!-- ğŸ”¹ í˜ì´ì§€ ê³µí†µ ì»¨í…Œì´ë„ˆ -->
    <div class="route-page-container">

        <!-- ğŸ”¹ ìƒë‹¨ íƒ€ì´í‹€ (ë¼ìš´ë“œ ì¹´ë“œ ë°–) -->
        <header class="route-title-bar">
            <h2 class="route-page-title">ì½”ìŠ¤ ìˆ˜ì •í•˜ê¸°</h2>
            <p class="route-page-sub">ì´ë¯¸ ë“±ë¡ëœ ëŸ¬ë‹ ì½”ìŠ¤ë¥¼ ìˆ˜ì •í•˜ê³  ê¸°ë¡ì„ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”.</p>
        </header>

        <!-- ğŸ”¹ ë¼ìš´ë“œ ì¹´ë“œ -->
        <div class="card">
            <div class="card-body">

                <!-- =========================
                     ì§€ë„ / ê²€ìƒ‰ ì˜ì—­
                ========================== -->
                <section class="mb-3">
                    <!-- ê²€ìƒ‰íˆ´ -->
                    <form id="searchForm">
                        <div class="input-group mb-3">
                            <input type="text"
                                   id="searchPlace"
                                   class="form-control"
                                   th:placeholder="${route.address}">
                            <button class="btn btn-outline-secondary" type="submit">ê²€ìƒ‰</button>
                        </div>
                    </form>

                    <!-- ì§€ë„ ë¶ˆëŸ¬ì˜¤ê¸° -->
                    <div id="map"
                         th:data-routepath="${route.routePath}"
                         style="width:100%;height:350px;"></div>
                    <p>
                        <em>ì§€ë„ë¥¼ ë§ˆìš°ìŠ¤ë¡œ í´ë¦­í•˜ë©´ ì„  ê·¸ë¦¬ê¸°ê°€ ì‹œì‘ë˜ê³ <br>ì˜¤ë¥¸ìª½ ë§ˆìš°ìŠ¤ë¥¼ í´ë¦­í•˜ë©´ ì„  ê·¸ë¦¬ê¸°ê°€ ì¢…ë£Œë©ë‹ˆë‹¤</em>
                    </p>
                </section>

                <!-- =========================
                     ì½”ìŠ¤ ì •ë³´ ìˆ˜ì • í¼
                ========================== -->
                <form action="/route/modify" method="post">
                    <input type="hidden" name="id" th:value="${route.id}">
                    <input type="hidden" name="email" th:value="'abc@naver.com'">

                    <!-- ì „ì†¡í•  map data -->
                    <input type="hidden" name="distance" id="mapDistance">
                    <input type="hidden" name="lat" id="mapLat">
                    <input type="hidden" name="lng" id="mapLng">
                    <input type="hidden" name="address" id="mapAddress">
                    <input type="hidden" name="routePath" id="routePath">

                    <!-- ì œëª© -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">ì œëª©</label>
                        <input type="text" name="title"
                               class="form-control"
                               th:value="${route.title}">
                    </div>

                    <!-- ë‚œì´ë„ -->
                    <div class="mb-3 d-flex align-items-start gap-3 flex-wrap">
                        <label class="form-label">ë‚œì´ë„</label>

                        <div class="btn-group" role="group" aria-label="ë‚œì´ë„ ì„ íƒ">
                            <!-- ì„œë²„ë¡œ ë³´ë‚¼ ì‹¤ì œ ë°ì´í„° -->
                            <input type="hidden" id="dataInput" name="difficulty" value="">

                            <!-- ë²„íŠ¼ í´ë¦­ ì‹œ JS í•¨ìˆ˜ í˜¸ì¶œ (setAndSubmit ê·¸ëŒ€ë¡œ ì‚¬ìš©) -->
                            <button type="button" id="btnHARD"
                                    onclick="setAndSubmit('HARD', this)"
                                    class="btn btn-outline-success">
                                ìƒ
                            </button>
                            <button type="button" id="btnMEDIUM"
                                    onclick="setAndSubmit('MEDIUM', this)"
                                    class="btn btn-outline-success">
                                ì¤‘
                            </button>
                            <button type="button" id="btnEASY"
                                    onclick="setAndSubmit('EASY', this)"
                                    class="btn btn-outline-success">
                                í•˜
                            </button>
                        </div>
                    </div>

                    <!-- ë‹¬ë¦° ì‹œê°„ (ì‹œ/ë¶„/ì´ˆ í•œ ì¤„ ë°°ì¹˜) -->
                    <div class="row g-3 mb-3">
                        <div class="col-12">
                            <label class="form-label fw-semibold">ë‹¬ë¦° ì‹œê°„</label>
                        </div>

                        <div class="col-12 col-sm-4">
                            <div class="input-group">
                                <input type="text" name="durationHr"
                                       class="form-control"
                                       th:value="${route.durationHr}">
                                <span class="input-group-text">ì‹œ</span>
                            </div>
                        </div>

                        <div class="col-12 col-sm-4">
                            <div class="input-group">
                                <input type="text" name="durationMin"
                                       class="form-control"
                                       th:value="${route.durationMin}">
                                <span class="input-group-text">ë¶„</span>
                            </div>
                        </div>

                        <div class="col-12 col-sm-4">
                            <div class="input-group">
                                <input type="text" name="durationS"
                                       class="form-control"
                                       th:value="${route.durationS}">
                                <span class="input-group-text">ì´ˆ</span>
                            </div>
                        </div>
                    </div>

                    <!-- ì‹¬ë°•ìˆ˜ -->
                    <div class="row g-3 mb-3">
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-semibold">í‰ê·  ì‹¬ë°•ìˆ˜</label>
                            <div class="input-group">
                                <input type="text" name="heartRateAvg"
                                       class="form-control"
                                       th:value="${route.heartRateAvg}">
                                <span class="input-group-text">BPM</span>
                            </div>
                        </div>

                        <div class="col-12 col-md-6">
                            <label class="form-label fw-semibold">ìµœëŒ€ ì‹¬ë°•ìˆ˜</label>
                            <div class="input-group">
                                <input type="text" name="heartRateMax"
                                       class="form-control"
                                       th:value="${route.heartRateMax}">
                                <span class="input-group-text">BPM</span>
                            </div>
                        </div>
                    </div>

                    <!-- ë©”ëª¨ -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">ë©”ëª¨</label>
                        <textarea name="description"
                                  class="form-control"
                                  rows="3">[[${route.description}]]</textarea>
                    </div>

                    <!-- ë²„íŠ¼ ì˜ì—­ -->
                    <div class="mb-3">
                        <button type="submit" class="btn btn-primary">ìˆ˜ì • ì™„ë£Œ</button>

                        <!-- ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°: ì½”ìŠ¤ ëª©ë¡ í˜ì´ì§€ -->
                        <a th:href="@{/route/list}">
                            <button type="button" class="btn btn-secondary">ëª©ë¡</button>
                        </a>
                    </div>
                </form>

            </div>
        </div><!-- /.card -->

    </div><!-- /.route-page-container -->
</div><!-- /layout:fragment="content" -->
<script layout:fragment="script" th:inline="javascript">

    // controllerì—ì„œ ëª¨ë¸ë¡œ ë„˜ê¸´ route.difficulty ê°’ì„ JS ë³€ìˆ˜ë¡œ ë°›ìŒ
    var difficulty = /*[[${route.difficulty}]]*/ null;
    // difficulty ê°’ì´ ì¡´ì¬í•˜ë©´ í•´ë‹¹ ë²„íŠ¼ì— active ë¶€ì—¬
    if (difficulty) {
        var btn = document.getElementById('btn'+difficulty);
        if(btn) {
            btn.classList.add('active');
        }
    }
    function setAndSubmit(value, btn) {
        // 'dataInput'ì´ë¼ëŠ” ì´ë¦„ì˜ ìˆ¨ê²¨ì§„ ì…ë ¥ë€ì— ê°’ ì„¤ì •
        document.getElementById('dataInput').value = value;

        // ëª¨ë“  ë²„íŠ¼ì—ì„œ active ì œê±°
        var buttons = document.querySelectorAll('.btn.btn-outline-success');
        buttons.forEach(b => b.classList.remove('active'));

        // í´ë¦­í•œ ë²„íŠ¼ì—ë§Œ active ì¶”ê°€
        btn.classList.add('active');
    }


    var lat = /*[[${route.lat}]]*/ 37.566826;
    var lng = /*[[${route.lng}]]*/ 126.9786567;

    var mapContainer = document.getElementById('map'), // ì§€ë„ë¥¼ í‘œì‹œí•  div
        mapOption = {
            center: new kakao.maps.LatLng(lat, lng), // ì§€ë„ì˜ ì¤‘ì‹¬ì¢Œí‘œ
            level: 4 // ì§€ë„ì˜ í™•ëŒ€ ë ˆë²¨
        };

    var map = new kakao.maps.Map(mapContainer, mapOption); // ì§€ë„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
    var ps = new kakao.maps.services.Places(); // ì¥ì†Œ ê²€ìƒ‰ ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
    var drawingFlag = false; // ì„ ì´ ê·¸ë ¤ì§€ê³  ìˆëŠ” ìƒíƒœë¥¼ ê°€ì§€ê³  ìˆì„ ë³€ìˆ˜ì…ë‹ˆë‹¤
    var moveLine; // ì„ ì´ ê·¸ë ¤ì§€ê³  ìˆì„ë•Œ ë§ˆìš°ìŠ¤ ì›€ì§ì„ì— ë”°ë¼ ê·¸ë ¤ì§ˆ ì„  ê°ì²´ ì…ë‹ˆë‹¤
    var clickLine // ë§ˆìš°ìŠ¤ë¡œ í´ë¦­í•œ ì¢Œí‘œë¡œ ê·¸ë ¤ì§ˆ ì„  ê°ì²´ì…ë‹ˆë‹¤
    var distanceOverlay; // ì„ ì˜ ê±°ë¦¬ì •ë³´ë¥¼ í‘œì‹œí•  ì»¤ìŠ¤í…€ì˜¤ë²„ë ˆì´ ì…ë‹ˆë‹¤
    var dots = []; // ì„ ì´ ê·¸ë ¤ì§€ê³  ìˆì„ë•Œ í´ë¦­í•  ë•Œë§ˆë‹¤ í´ë¦­ ì§€ì ê³¼ ê±°ë¦¬ë¥¼ í‘œì‹œí•˜ëŠ” ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ ë°°ì—´ì…ë‹ˆë‹¤.
    var geocoder = new kakao.maps.services.Geocoder();


    // routePath ì½ì–´ì„œ íŒŒì‹±
    var rawPath = mapContainer.dataset.routepath || "[]";
    let coords = [];
    try { coords = JSON.parse(rawPath); } catch (e) {console.warn(e);}

    let originalLine = null;
    if(coords.length >= 2) {
        var latlngs = coords.map(p => new kakao.maps.LatLng(p.lat, p.lng));

        originalLine = new kakao.maps.Polyline({
            map,
            path: latlngs,
            strokeWeight: 3,
            strokeColor: '#db4040',
            strokeOpacity: 1,
            strokeStyle: 'solid'
        });

        // ì½”ìŠ¤ ì „ì²´ê°€ ë³´ì´ë„ë¡ Bounds ë§ì¶¤
        var originalBounds = new kakao.maps.LatLngBounds();
        latlngs.forEach(ll => originalBounds.extend(ll));
        map.setBounds(originalBounds);


        var startPos = latlngs[0];
        var endPos = latlngs[latlngs.length - 1];

        // ì‹œì‘ì  dot
        var startDot = new kakao.maps.CustomOverlay({
            map, position: startPos, zIndex: 2,
            content: '<span class="dot"></span>'
        });
        // ë„ì°©ì  dot
        var endDot = new kakao.maps.CustomOverlay({
            map, position: endPos, zIndex: 2,
            content: '<span class="dot"></span>'
        });

        // ì´ê±°ë¦¬ ê³„ì‚° (ì„œë²„ ì €ì¥ê°’ì´ ìˆìœ¼ë©´ ê·¸ ê°’ì„ ìš°ì„  ì‚¬ìš©)
        // poly.getLength()ë¡œ ê³„ì‚°
        var distance = (Math.round(originalLine.getLength())); // m ë‹¨ìœ„ ì •ìˆ˜

        // ë³´ê¸° ì¢‹ì€ í¬ë§· (1km ì´ìƒì´ë©´ ì†Œìˆ˜ 1ìë¦¬ km)
        var formatDistance = m => (m >= 1000 ? (m/1000).toFixed(1) + 'km' : m + 'm');

        // ì¶œë°œì§€ ì˜¤ë²„ë ˆì´: ì‹œì‘ì ì— í•œ ë²ˆë§Œ í‘œì‹œ
        var startDotOverlay = new kakao.maps.CustomOverlay({
            map, position: startPos, zIndex: 3, yAnchor: 1,
            content: '<div class="dotOverlay">ì¶œë°œì </div>'
        });

        // ì´ê±°ë¦¬ ì˜¤ë²„ë ˆì´: ë„ì°©ì ì— í•œ ë²ˆë§Œ í‘œì‹œ
        var endDotOverlay = new kakao.maps.CustomOverlay({
            map, position: endPos, zIndex: 3, yAnchor: 1,
            content: '<div class="dotOverlay">ë„ì°©ì  <span class="number">' + formatDistance(distance) + '</span></div>'
        });
    }

    // ê¸°ì¡´ ì„  ì‚­ì œ í•¨ìˆ˜
    function deleteOriginalLine() {
        if(originalLine) {
            originalLine.setMap(null);
            originalLine = null;
        }
        if(startDot) {
            startDot.setMap(null);
            startDot = null;
        }
        if(endDot) {
            endDot.setMap(null);
            endDot = null;
        }
        if(startDotOverlay) {
            startDotOverlay.setMap(null);
            startDotOverlay = null;
        }
        if(endDotOverlay) {
            endDotOverlay.setMap(null);
            endDotOverlay = null;
        }
    }


    // ì§€ë„ì— í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤
    // ì§€ë„ë¥¼ í´ë¦­í•˜ë©´ ì„  ê·¸ë¦¬ê¸°ê°€ ì‹œì‘ë©ë‹ˆë‹¤ ê·¸ë ¤ì§„ ì„ ì´ ìˆìœ¼ë©´ ì§€ìš°ê³  ë‹¤ì‹œ ê·¸ë¦½ë‹ˆë‹¤
    kakao.maps.event.addListener(map, 'click', function(mouseEvent) {

        // ë§ˆìš°ìŠ¤ë¡œ í´ë¦­í•œ ìœ„ì¹˜ì…ë‹ˆë‹¤
        var clickPosition = mouseEvent.latLng;

        // ì§€ë„ í´ë¦­ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆëŠ”ë° ì„ ì„ ê·¸ë¦¬ê³ ìˆëŠ” ìƒíƒœê°€ ì•„ë‹ˆë©´
        if (!drawingFlag) {

            // ìƒíƒœë¥¼ trueë¡œ, ì„ ì´ ê·¸ë¦¬ê³ ìˆëŠ” ìƒíƒœë¡œ ë³€ê²½í•©ë‹ˆë‹¤
            drawingFlag = true;

            deleteOriginalLine(); // ì´ì „ ê²½ë¡œ ì‚­ì œ
            deleteClickLine();  // ì§€ë„ ìœ„ì— ì„ ì´ í‘œì‹œë˜ê³  ìˆë‹¤ë©´ ì§€ë„ì—ì„œ ì œê±°í•©ë‹ˆë‹¤
            deleteDistnce();    // ì§€ë„ ìœ„ì— ì»¤ìŠ¤í…€ì˜¤ë²„ë ˆì´ê°€ í‘œì‹œë˜ê³  ìˆë‹¤ë©´ ì§€ë„ì—ì„œ ì œê±°í•©ë‹ˆë‹¤
            deleteCircleDot();  // ì§€ë„ ìœ„ì— ì„ ì„ ê·¸ë¦¬ê¸° ìœ„í•´ í´ë¦­í•œ ì§€ì ê³¼ í•´ë‹¹ ì§€ì ì˜ ê±°ë¦¬ì •ë³´ê°€ í‘œì‹œë˜ê³  ìˆë‹¤ë©´ ì§€ë„ì—ì„œ ì œê±°í•©ë‹ˆë‹¤

            // í´ë¦­í•œ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì„ ì„ ìƒì„±í•˜ê³  ì§€ë„ìœ„ì— í‘œì‹œí•©ë‹ˆë‹¤
            clickLine = new kakao.maps.Polyline({
                map: map, // ì„ ì„ í‘œì‹œí•  ì§€ë„ì…ë‹ˆë‹¤
                path: [clickPosition], // ì„ ì„ êµ¬ì„±í•˜ëŠ” ì¢Œí‘œ ë°°ì—´ì…ë‹ˆë‹¤ í´ë¦­í•œ ìœ„ì¹˜ë¥¼ ë„£ì–´ì¤ë‹ˆë‹¤
                strokeWeight: 3, // ì„ ì˜ ë‘ê»˜ì…ë‹ˆë‹¤
                strokeColor: '#db4040', // ì„ ì˜ ìƒ‰ê¹”ì…ë‹ˆë‹¤
                strokeOpacity: 1, // ì„ ì˜ ë¶ˆíˆ¬ëª…ë„ì…ë‹ˆë‹¤ 0ì—ì„œ 1 ì‚¬ì´ê°’ì´ë©° 0ì— ê°€ê¹Œìš¸ìˆ˜ë¡ íˆ¬ëª…í•©ë‹ˆë‹¤
                strokeStyle: 'solid' // ì„ ì˜ ìŠ¤íƒ€ì¼ì…ë‹ˆë‹¤
            });

            // ì„ ì´ ê·¸ë ¤ì§€ê³  ìˆì„ ë•Œ ë§ˆìš°ìŠ¤ ì›€ì§ì„ì— ë”°ë¼ ì„ ì´ ê·¸ë ¤ì§ˆ ìœ„ì¹˜ë¥¼ í‘œì‹œí•  ì„ ì„ ìƒì„±í•©ë‹ˆë‹¤
            moveLine = new kakao.maps.Polyline({
                strokeWeight: 3, // ì„ ì˜ ë‘ê»˜ì…ë‹ˆë‹¤
                strokeColor: '#db4040', // ì„ ì˜ ìƒ‰ê¹”ì…ë‹ˆë‹¤
                strokeOpacity: 0.5, // ì„ ì˜ ë¶ˆíˆ¬ëª…ë„ì…ë‹ˆë‹¤ 0ì—ì„œ 1 ì‚¬ì´ê°’ì´ë©° 0ì— ê°€ê¹Œìš¸ìˆ˜ë¡ íˆ¬ëª…í•©ë‹ˆë‹¤
                strokeStyle: 'solid' // ì„ ì˜ ìŠ¤íƒ€ì¼ì…ë‹ˆë‹¤
            });

            // í´ë¦­í•œ ì§€ì ì— ëŒ€í•œ ì •ë³´ë¥¼ ì§€ë„ì— í‘œì‹œí•©ë‹ˆë‹¤
            displayCircleDot(clickPosition, 0);

        } else { // ì„ ì´ ê·¸ë ¤ì§€ê³  ìˆëŠ” ìƒíƒœì´ë©´

            // ê·¸ë ¤ì§€ê³  ìˆëŠ” ì„ ì˜ ì¢Œí‘œ ë°°ì—´ì„ ì–»ì–´ì˜µë‹ˆë‹¤
            var path = clickLine.getPath();

            // ì¢Œí‘œ ë°°ì—´ì— í´ë¦­í•œ ìœ„ì¹˜ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤
            path.push(clickPosition);

            // ë‹¤ì‹œ ì„ ì— ì¢Œí‘œ ë°°ì—´ì„ ì„¤ì •í•˜ì—¬ í´ë¦­ ìœ„ì¹˜ê¹Œì§€ ì„ ì„ ê·¸ë¦¬ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤
            clickLine.setPath(path);

            var distance = Math.round(clickLine.getLength());
            displayCircleDot(clickPosition, distance);
        }
    });


    // ì§€ë„ì— ë§ˆìš°ìŠ¤ë¬´ë¸Œ ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤
    // ì„ ì„ ê·¸ë¦¬ê³ ìˆëŠ” ìƒíƒœì—ì„œ ë§ˆìš°ìŠ¤ë¬´ë¸Œ ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ ê·¸ë ¤ì§ˆ ì„ ì˜ ìœ„ì¹˜ë¥¼ ë™ì ìœ¼ë¡œ ë³´ì—¬ì£¼ë„ë¡ í•©ë‹ˆë‹¤
    kakao.maps.event.addListener(map, 'mousemove', function (mouseEvent) {

        // ì§€ë„ ë§ˆìš°ìŠ¤ë¬´ë¸Œ ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆëŠ”ë° ì„ ì„ ê·¸ë¦¬ê³ ìˆëŠ” ìƒíƒœì´ë©´
        if (drawingFlag){

            // ë§ˆìš°ìŠ¤ ì»¤ì„œì˜ í˜„ì¬ ìœ„ì¹˜ë¥¼ ì–»ì–´ì˜µë‹ˆë‹¤
            var mousePosition = mouseEvent.latLng;

            // ë§ˆìš°ìŠ¤ í´ë¦­ìœ¼ë¡œ ê·¸ë ¤ì§„ ì„ ì˜ ì¢Œí‘œ ë°°ì—´ì„ ì–»ì–´ì˜µë‹ˆë‹¤
            var path = clickLine.getPath();

            // ë§ˆìš°ìŠ¤ í´ë¦­ìœ¼ë¡œ ê·¸ë ¤ì§„ ë§ˆì§€ë§‰ ì¢Œí‘œì™€ ë§ˆìš°ìŠ¤ ì»¤ì„œ ìœ„ì¹˜ì˜ ì¢Œí‘œë¡œ ì„ ì„ í‘œì‹œí•©ë‹ˆë‹¤
            var movepath = [path[path.length-1], mousePosition];
            moveLine.setPath(movepath);
            moveLine.setMap(map);

            var distance = Math.round(clickLine.getLength() + moveLine.getLength()), // ì„ ì˜ ì´ ê±°ë¦¬ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤
                content = '<div class="dotOverlay distanceInfo">ì´ê±°ë¦¬ <span class="number">' + distance + '</span>m</div>'; // ì»¤ìŠ¤í…€ì˜¤ë²„ë ˆì´ì— ì¶”ê°€ë  ë‚´ìš©ì…ë‹ˆë‹¤
            // console.log(clickLine.getLength() + moveLine.getLength())
            // ê±°ë¦¬ì •ë³´ë¥¼ ì§€ë„ì— í‘œì‹œí•©ë‹ˆë‹¤
            showDistance(content, mousePosition);
        }
    });


    var totalDistanceValue=0, lastLat=null, lastLng=null, lastAddress="";
    // ì§€ë„ì— ë§ˆìš°ìŠ¤ ì˜¤ë¥¸ìª½ í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤
    // ì„ ì„ ê·¸ë¦¬ê³ ìˆëŠ” ìƒíƒœì—ì„œ ë§ˆìš°ìŠ¤ ì˜¤ë¥¸ìª½ í´ë¦­ ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ ì„  ê·¸ë¦¬ê¸°ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤
    kakao.maps.event.addListener(map, 'rightclick', function (mouseEvent) {

        // ì§€ë„ ì˜¤ë¥¸ìª½ í´ë¦­ ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆëŠ”ë° ì„ ì„ ê·¸ë¦¬ê³ ìˆëŠ” ìƒíƒœì´ë©´
        if (drawingFlag) {

            // ë§ˆìš°ìŠ¤ë¬´ë¸Œë¡œ ê·¸ë ¤ì§„ ì„ ì€ ì§€ë„ì—ì„œ ì œê±°í•©ë‹ˆë‹¤
            moveLine.setMap(null);
            moveLine = null;

            // ë§ˆìš°ìŠ¤ í´ë¦­ìœ¼ë¡œ ê·¸ë¦° ì„ ì˜ ì¢Œí‘œ ë°°ì—´ì„ ì–»ì–´ì˜µë‹ˆë‹¤
            var path = clickLine.getPath();

            // ì„ ì„ êµ¬ì„±í•˜ëŠ” ì¢Œí‘œì˜ ê°œìˆ˜ê°€ 2ê°œ ì´ìƒì´ë©´
            if (path.length > 1) {

                // kakao.maps.LatLng[] -> [{lat, lng}, ...] ë¡œ ë³€í™˜
                var pathArr = path.map(p => ({ lat: p.getLat(), lng: p.getLng() }));
                // ìˆ¨ì€ í•„ë“œì— JSON ë¬¸ìì—´ë¡œ ë„£ê¸°
                document.getElementById('routePath').value = JSON.stringify(pathArr);

                // ë§ˆì§€ë§‰ í´ë¦­ ì§€ì ì— ëŒ€í•œ ê±°ë¦¬ ì •ë³´ ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ë¥¼ ì§€ì›ë‹ˆë‹¤
                if (dots[dots.length-1].distance) {
                    dots[dots.length-1].distance.setMap(null);
                    dots[dots.length-1].distance = null;
                }

                totalDistanceValue = Math.round(clickLine.getLength()); // ì„ ì˜ ì´ ê±°ë¦¬ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤

                // ë§ˆì§€ë§‰ í´ë¦­ ì§€ì  ì¢Œí‘œ (kakao.maps.LatLng)
                var lastLatLng = path[path.length - 1];
                lastLat = lastLatLng.getLat();
                lastLng = lastLatLng.getLng();


                // ì¢Œí‘œ -> ì£¼ì†Œ ë³€í™˜ (coord2Address ì‚¬ìš©)
                geocoder.coord2Address(lastLng, lastLat, function(result, status) {
                    if (status === kakao.maps.services.Status.OK) {
                        // result ë°°ì—´ì˜ ì²« í•­ëª©ì— ì£¼ì†Œ ì •ë³´ê°€ ìˆìŒ
                        lastAddress = result[0].address ? result[0].address.address_name : '';

                        console.log("ìœ„ë„:", lastLat);
                        console.log("ê²½ë„:", lastLng);
                        console.log("ë³€í™˜ëœ ì£¼ì†Œ:", lastAddress);
                        console.log("ì´ê±°ë¦¬ ì €ì¥ë¨: ", totalDistanceValue);

                        document.getElementById('mapDistance').value = totalDistanceValue;
                        document.getElementById('mapLat').value = lastLat;
                        document.getElementById('mapLng').value = lastLng;
                        document.getElementById('mapAddress').value = lastAddress;

                        // ì„œë²„ë¡œ ì „ì†¡ (fetch)
                        // var payload = {
                        //     distance: totalDistanceValue,
                        //     address: address,
                        //     lat: lat,
                        //     lng: lng
                        // };

                        // fetch('/route/saveMapData', {
                        //     method: 'POST',
                        //     headers: {
                        //         'Content-Type': 'application/json'
                        //     },
                        //     body: JSON.stringify(payload)
                        // })
                        // .then(res => {
                        // if(!res.ok) throw new Error('ì„œë²„ ì‘ë‹µ ì—ëŸ¬: ' + res.status);
                        // return res.json();
                        // })
                        // .then(data => {
                        // console.log('ì„œë²„ ì €ì¥ ì™„ë£Œ', data);
                        // })
                        // .catch(err => console.error('ì €ì¥ ì¤‘ ì˜¤ë¥˜:', err));

                    }else{
                        console.warn("ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨:", status);
                    }
                });


                content = getTimeHTML(totalDistanceValue); // ì»¤ìŠ¤í…€ì˜¤ë²„ë ˆì´ì— ì¶”ê°€ë  ë‚´ìš©ì…ë‹ˆë‹¤
                showDistance(content, path[path.length-1]); // ê·¸ë ¤ì§„ ì„ ì˜ ê±°ë¦¬ì •ë³´ë¥¼ ì§€ë„ì— í‘œì‹œí•©ë‹ˆë‹¤

            } else {
                // ì„ ì„ êµ¬ì„±í•˜ëŠ” ì¢Œí‘œì˜ ê°œìˆ˜ê°€ 1ê°œ ì´í•˜ì´ë©´
                // ì§€ë„ì— í‘œì‹œë˜ê³  ìˆëŠ” ì„ ê³¼ ì •ë³´ë“¤ì„ ì§€ë„ì—ì„œ ì œê±°í•©ë‹ˆë‹¤.
                deleteClickLine();
                deleteCircleDot();
                deleteDistnce();
            }

            // ìƒíƒœë¥¼ falseë¡œ, ê·¸ë¦¬ì§€ ì•Šê³  ìˆëŠ” ìƒíƒœë¡œ ë³€ê²½í•©ë‹ˆë‹¤
            drawingFlag = false;
        }
    });



    // í´ë¦­ìœ¼ë¡œ ê·¸ë ¤ì§„ ì„ ì„ ì§€ë„ì—ì„œ ì œê±°í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤
    function deleteClickLine() {
        if (clickLine) {
            clickLine.setMap(null);
            clickLine = null;
        }
    }

    // ë§ˆìš°ìŠ¤ ë“œë˜ê·¸ë¡œ ê·¸ë ¤ì§€ê³  ìˆëŠ” ì„ ì˜ ì´ê±°ë¦¬ ì •ë³´ë¥¼ í‘œì‹œí•˜ê±°
    // ë§ˆìš°ìŠ¤ ì˜¤ë¥¸ìª½ í´ë¦­ìœ¼ë¡œ ì„  ê·¸ë¦¬ê°€ ì¢…ë£Œëì„ ë•Œ ì„ ì˜ ì •ë³´ë¥¼ í‘œì‹œí•˜ëŠ” ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ë¥¼ ìƒì„±í•˜ê³  ì§€ë„ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤
    function showDistance(content, position) {

        if (distanceOverlay) { // ì»¤ìŠ¤í…€ì˜¤ë²„ë ˆì´ê°€ ìƒì„±ëœ ìƒíƒœì´ë©´

            // ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ì˜ ìœ„ì¹˜ì™€ í‘œì‹œí•  ë‚´ìš©ì„ ì„¤ì •í•©ë‹ˆë‹¤
            distanceOverlay.setPosition(position);
            distanceOverlay.setContent(content);

        } else { // ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ê°€ ìƒì„±ë˜ì§€ ì•Šì€ ìƒíƒœì´ë©´

            // ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ë¥¼ ìƒì„±í•˜ê³  ì§€ë„ì— í‘œì‹œí•©ë‹ˆë‹¤
            distanceOverlay = new kakao.maps.CustomOverlay({
                map: map, // ì»¤ìŠ¤í…€ì˜¤ë²„ë ˆì´ë¥¼ í‘œì‹œí•  ì§€ë„ì…ë‹ˆë‹¤
                content: content,  // ì»¤ìŠ¤í…€ì˜¤ë²„ë ˆì´ì— í‘œì‹œí•  ë‚´ìš©ì…ë‹ˆë‹¤
                position: position, // ì»¤ìŠ¤í…€ì˜¤ë²„ë ˆì´ë¥¼ í‘œì‹œí•  ìœ„ì¹˜ì…ë‹ˆë‹¤.
                xAnchor: 0,
                yAnchor: 0,
                zIndex: 3
            });
        }
    }

    // ê·¸ë ¤ì§€ê³  ìˆëŠ” ì„ ì˜ ì´ê±°ë¦¬ ì •ë³´ì™€
    // ì„  ê·¸ë¦¬ê°€ ì¢…ë£Œëì„ ë•Œ ì„ ì˜ ì •ë³´ë¥¼ í‘œì‹œí•˜ëŠ” ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ë¥¼ ì‚­ì œí•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤
    function deleteDistnce () {
        if (distanceOverlay) {
            distanceOverlay.setMap(null);
            distanceOverlay = null;
        }
    }

    // ì„ ì´ ê·¸ë ¤ì§€ê³  ìˆëŠ” ìƒíƒœì¼ ë•Œ ì§€ë„ë¥¼ í´ë¦­í•˜ë©´ í˜¸ì¶œí•˜ì—¬
    // í´ë¦­ ì§€ì ì— ëŒ€í•œ ì •ë³´ (ë™ê·¸ë¼ë¯¸ì™€ í´ë¦­ ì§€ì ê¹Œì§€ì˜ ì´ê±°ë¦¬)ë¥¼ í‘œì¶œí•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤
    function displayCircleDot(position, distance) {

        // í´ë¦­ ì§€ì ì„ í‘œì‹œí•  ë¹¨ê°„ ë™ê·¸ë¼ë¯¸ ì»¤ìŠ¤í…€ì˜¤ë²„ë ˆì´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
        var circleOverlay = new kakao.maps.CustomOverlay({
            content: '<span class="dot"></span>',
            position: position,
            zIndex: 1
        });

        // ì§€ë„ì— í‘œì‹œí•©ë‹ˆë‹¤
        circleOverlay.setMap(map);

        if (distance > 0) {
            // í´ë¦­í•œ ì§€ì ê¹Œì§€ì˜ ê·¸ë ¤ì§„ ì„ ì˜ ì´ ê±°ë¦¬ë¥¼ í‘œì‹œí•  ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
            var distanceOverlay = new kakao.maps.CustomOverlay({
                content: '<div class="dotOverlay">ê±°ë¦¬ <span class="number">' + distance + '</span>m</div>',
                position: position,
                yAnchor: 1,
                zIndex: 2
            });

            // ì§€ë„ì— í‘œì‹œí•©ë‹ˆë‹¤
            distanceOverlay.setMap(map);
        }

        // ë°°ì—´ì— ì¶”ê°€í•©ë‹ˆë‹¤
        dots.push({circle:circleOverlay, distance: distanceOverlay});
    }

    // í´ë¦­ ì§€ì ì— ëŒ€í•œ ì •ë³´ (ë™ê·¸ë¼ë¯¸ì™€ í´ë¦­ ì§€ì ê¹Œì§€ì˜ ì´ê±°ë¦¬)ë¥¼ ì§€ë„ì—ì„œ ëª¨ë‘ ì œê±°í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤
    function deleteCircleDot() {
        var i;

        for ( i = 0; i < dots.length; i++ ){
            if (dots[i].circle) {
                dots[i].circle.setMap(null);
            }

            if (dots[i].distance) {
                dots[i].distance.setMap(null);
            }
        }

        dots = [];
    }

    // ë§ˆìš°ìŠ¤ ìš°í´ë¦­ í•˜ì—¬ ì„  ê·¸ë¦¬ê¸°ê°€ ì¢…ë£Œëì„ ë•Œ í˜¸ì¶œí•˜ì—¬
    // ê·¸ë ¤ì§„ ì„ ì˜ ì´ê±°ë¦¬ ì •ë³´ë¥¼
    // HTML Contentë¥¼ ë§Œë“¤ì–´ ë¦¬í„´í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤
    function getTimeHTML(distance) {
        // ê±°ë¦¬ì™€ ë„ë³´ ì‹œê°„, ìì „ê±° ì‹œê°„ì„ ê°€ì§€ê³  HTML Contentë¥¼ ë§Œë“¤ì–´ ë¦¬í„´í•©ë‹ˆë‹¤
        var content = '<ul class="dotOverlay distanceInfo">';
        content += '    <li>';
        content += '        <span class="label">ì´ê±°ë¦¬</span><span class="number">' + distance + '</span>m';
        content += '    </li>';
        content += '</ul>'
        return content;
    }


    // ê²€ìƒ‰ í¼ ì´ë²¤íŠ¸ ì—°ê²°
    document.getElementById('searchForm').addEventListener('submit', function(e) {
        e.preventDefault();

        var keyword = document.getElementById('searchPlace').value;
        if (!keyword.trim()) {
            alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”!');
            return;
        }

        // í‚¤ì›Œë“œë¡œ ì¥ì†Œë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤
        ps.keywordSearch(keyword, placesSearchCB);
    });


    // í‚¤ì›Œë“œ ê²€ìƒ‰ ì™„ë£Œ ì‹œ í˜¸ì¶œë˜ëŠ” ì½œë°±í•¨ìˆ˜ ì…ë‹ˆë‹¤
    function placesSearchCB (data, status, pagination) {
        if (status === kakao.maps.services.Status.OK) {

            // ê²€ìƒ‰ëœ ì¥ì†Œ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì§€ë„ ë²”ìœ„ë¥¼ ì¬ì„¤ì •í•˜ê¸°ìœ„í•´
            // LatLngBounds ê°ì²´ì— ì¢Œí‘œë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤
            var bounds = new kakao.maps.LatLngBounds();

            for (var i=0; i<data.length; i++) {
                bounds.extend(new kakao.maps.LatLng(data[i].y, data[i].x));
            }

            // ê²€ìƒ‰ëœ ì¥ì†Œ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì§€ë„ ë²”ìœ„ë¥¼ ì¬ì„¤ì •í•©ë‹ˆë‹¤
            map.setBounds(bounds);

            var center = map.getCenter();
            var centerCoords = {
                lat: center.getLat(),
                lng: center.getLng()
            };
            console.log("ì§€ë„ ì¤‘ì‹¬ì¢Œí‘œ ì €ì¥ë¨:", centerCoords)

        }
    }
</script>


